# ESP-IDF 程序结构和启动流程

在上一课中，我们了解了一个基于 ESP-IDF 的工程目录的基本组成。今天，我们将学习 ESP-IDF 程序的结构和启动流程。

## 程序存储结构

在我们使用 ESP-IDF 的 `py build` 命令进行编译后，编译器会根据代码区分出指令总线和数据总线。指令总线部分是可以执行的，例如我们定义的函数；而数据总线部分是不可执行的，只能通过字节操作访问，例如全局变量。

程序存储结构中包含以下几种类型：

1. **DRAM（数据 RAM）**  
   属于数据总线部分，用于存储非常量静态数据和零初始化数据。这些数据通常由链接器放入内部 SRAM 中，也可以配置为放入外部 RAM。

2. **.bss 段**  
   同样属于数据总线部分，用于存储未初始化的全局变量。这些数据由链接器放入内部 SRAM，也可以配置为放入外部存储器。

3. **IRAM（指令 RAM）**  
   属于指令总线部分，是 ESP-IDF 内部 SRAM 的一部分，用于存储指令。例如，中断处理程序通常会放在指令 RAM 中。我们也可以通过使用 `iram_attr` 宏，在源代码中指定需要放入 IRAM 的代码。

4. **IROM（指令 ROM）**  
   属于指令总线部分，用于存储未明确声明在 IRAM 或 RTC 存储器中的函数。这些函数通常会被放在 IROM 中。

5. **DROM（数据 ROM）**  
   属于数据总线部分，用于存放只读数据，例如代码中的常量数据。

6. **RTC Slow Memory**  
   属于数据总线部分，用于存储在深度睡眠模式中保持不变的值。通过使用 `RTC_NOINIT_ATTR` 宏，可以将数据放入 RTC Slow Memory 中。

7. **RTC Flash Memory**  
   具有指令和数据存储器的双重属性，既可以作为指令存储器，也可以作为数据存储器进行访问。从深度睡眠模式唤醒后，必须运行的代码需要放在 RTC 存储器中。

## 启动流程

ESP-IDF 的启动流程可以分为三个阶段：

1. **第一阶段：引导程序（Bootloader）**  
   - 引导程序固化在 ROM 中，不可修改。  
   - 它负责加载二级引导程序至 RAM 中运行，并检查 GPIO 引脚以选择程序模式。  
   - 当芯片上电时，如果检测到 GPIO0 引脚为低电平，则进入下载模式；否则，进入二级引导程序。

2. **第二阶段：二级引导程序（Second Stage Bootloader）**  
   - 二级引导程序从地址 `0x878000` 处读取分区表，并处理各种段。  
   - 例如，将 IRAM 内容拷贝到内存中，并加载应用程序。  
   - 这一阶段还会进行硬件外设的初始化和基本 C 语言运行环境的初始化。

3. **第三阶段：应用程序启动**  
   - 在这一阶段，FreeRTOS 操作系统会被初始化。  
   - 最后，执行 `app_main` 任务，进入 `app_main` 函数。  
   - `app_main` 函数是应用程序的入口点。

## 总结

ESP32 的启动流程比一些常见的 MCU（如 STM32）稍微复杂一些。不过，通常我们不需要深入了解这些启动流程，因为 ESP-IDF 已经为我们处理好了这些细节，并且非常稳定。我们只需要关注 `app_main` 函数中的应用程序逻辑即可。

今天的介绍就到这里。
