这节课也是 FreeRTOS 部分的最后一课。从严格意义上来讲，FreeRTOS 是一个操作系统内核，它与 Linux 不一样。Linux 支持多用户、多任务、多线程操作，具备强大的文件系统、网络协议栈和大量的应用程序支持，适用于服务器、桌面设备、移动设备等。FreeRTOS 主要关注任务调度、内存管理和中断处理，适用于智能家居、工业控制、汽车电子和医疗设备等领域。而且 FreeRTOS 开源免费的特性，因此很多厂商都使用 FreeRTOS 为基础来设计自己的 SDK。

  在乐鑫的 ESP-IDF 开发环境中，原生的 FreeRTOS 和 ESP-IDF 的 FreeRTOS 稍有不同，这里给大家简单介绍一下主要可能对我们有影响的不同点。由于 ESP32 是双核架构，程序可以真正地做到并行，但原生的 FreeRTOS 代码没有考虑双核的处理，这里需要注意。原生的 FreeRTOS 从 11.0 版本开始支持 a-AMP（非对称多处理架构）功能，也就是可以支持多核，但这里的多核处理和 ESP-IDF 版本的双核处理不一样，在使用中有一些地方需要注意。

  第一个问题是优先级问题。在较高优先级的任务正在运行时，较低优先级的任务无法运行。虽然这在单核上是正确的，但并不适用于多核情况，因为多个任务可以同时运行。如果应用程序依赖于相对任务优先级来提供互斥，则可能在多核环境中观察到意想不到的结果。

  第二点是 ESP-IDF 版本会自动创建五个任务。第一个任务是空闲任务，在每个核上都会创建一个，它的优先级是零；第二个是 FreeRTOS 定时器任务，它的优先级是一；第三个是 App 主任务，优先级是一，也就是我们的应用入口；第四个是 IPC 任务，每个核创建一个用于处理多核协调，优先级是 24，也就是最高优先级；第五个是 ESP 定时器任务，它负责 ESP 定时器的回调，优先级是 22。

  第三点是 ESP-IDF 的 FreeRTOS 版本不使用原生 FreeRTOS 的内存管理，它实现了自己的堆管理机制。

  第四点是创建任务的方式不同。原生 FreeRTOS 使用 xTaskCreate 或 xTaskCreateStatic，而 ESP-IDF 版本使用 xTaskCreatePinnedToCore，还可以指定任务运行在哪个核上。不过 ESP-IDF 也支持 xTaskCreate 这个函数，本质上内部会调用 xTaskCreatePinnedToCore，并将任务指定在可以在任意一个核上运行，也就是没有绑定到特定核（tskNO_AFFINITY）。

  第五点是删除任务时，应避免删除另一个核上的任务，因为这可能会带来意想不到的结果。

  第六点是临界区在 ESP32 双核系统中，仅仅禁用中断并不能构成临界区，因为存在其他核，这意味着共享资源仍然可以同时访问。因此，应该采用自旋锁的方式确保同步。

  第七点是如果任务中用到浮点运算，则创建任务时必须指定具体运行在哪个核上，不能由系统自动安排，也就是说不能使用 tskNO_AFFINITY 宏来指定运行的核，这是由 ESP32 的 FPU 寄存器特性决定的。

  基于上述不同点，个人建议如下：程序应用开发中创建任务时应指定内核，尽量不要使用 tskNO_AFFINITY，因为使用这个宏会让调度器在 CPU0 或 CPU1 上都有机会运行任务，可能会对程序造成不确定的影响，比如上述第五点和第七点提到的问题。第二点是通常负责处理无线网络的任务（比如 Wi-Fi、蓝牙）会被固定到 CPU0 上，而处理应用程序的其余部分的任务会被固定到 CPU1 上。这也是为什么我在前几课中写的那些任务都是分配到 CPU1 上运行的。

  本节课内容到此结束。关于 FreeRTOS 的使用源码可以在配套的 Git 仓库中找到，在 esp32board 的 FreeRTOS 目录下可以获取。
