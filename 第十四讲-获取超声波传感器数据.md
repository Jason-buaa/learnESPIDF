# 超声波传感器测距原理与 HCSR04 模块应用

这节课给大家介绍如何获取 HCSR04。超声波传感器可以测距，其原理是利用超声波的反射特性。超声波频率高于 20 千赫兹，人耳无法听到。传感器发射超声波并接收反射波，记录发射和接收的时间差，结合声速（约 340 米/秒），即可计算距离。

HCSR04 是常用的超声波测距模块，内部集成发送和接收电路。它有四个引脚：VCC、TRIG、ECHO 和 GND。VCC 和 GND 用于供电（3.3 到 5 伏），TRIG 和 ECHO 用于信号触发和回响。工作时序是 TRIG 引脚触发约 10 微秒的电平信号，模块内部会自动发出 8 个 40 千赫兹的超声波。程序监控 ECHO 引脚，返回一段高电平持续时间，这个时间即为超声波从发射到返回的时间。通过公式：距离 D = (速度 V × 时间 T) / 2，可以计算出距离值。

在代码实现上，需要使用输入捕获功能来捕获 ECHO 引脚上的脉冲宽度。具体步骤包括初始化捕获定时器、新建捕获通道、定义回调函数等。回调函数用于处理捕获到的边缘事件，记录上升沿和下降沿的定时器值，并计算时间差。通过任务通知函数，将脉宽长度发送到主函数中进行进一步处理。最终，通过公式计算出距离的厘米值。

具体代码在 KITTY 仓库 ESP32 BOARD S204 目录下，代码仓库下载地址已放视频简介处。我们打开工程后看到，由于代码比较简单，全部代码都放在 MAY.C 文件中了，总共加起来大概就是 100 来行。直接看 MAIN 函数：因为要用到定时器捕获功能，这里需要初始化相应的捕获定时器。在 ESPITF 中，定时器捕获功能属于 MCP 的 BN 组件，这个组件功能非常强大，可以用于驱动无刷电机六路 PETER RM 控制，但我们不需要用到这么强大的功能，只需要捕获功能即可。源码中要包含 MCPWMCAP 头文件，这样才能使用相应的捕获功能。

定义和初始化一个捕获定时器结构体，这个结构体里面有三个成员，但我们一般只需要用到 CLOCK SHOT 成员，它指定使用的时钟源。我们看到它本质上使用的是 APP 时钟源，这个时钟源是 ESP3 内部用于绝大部分外设的时钟源。

接下来返回 MAY.C 函数，配置完结构体成员后，调用 MCPVN NEW CAPTURE TIMER 函数完成捕获定时器的初始化，这里会返回一个捕获定时器的句柄。然后需要新建一个捕获通道用于电平边缘的捕获，定义和初始化捕获通道配置结构体变量，这个结构体变量要初始化五个成员：第一个是 GPIO 引脚，也就是 NO 引脚；第二个是分频系数，这里写 1 表示不分频；第三个是否捕获下降沿，我们这里是 TRUE；第四个是否捕获上升沿，我们这里也是 TRUE；最后一个是否启用上拉电阻，如果外部电路有上拉电阻，这里可不配置，配套开发板上有上拉电阻，但我们这里配置也不会影响。

调用 MCP REN NEW CAPTURE CHANNEL 函数完成捕获通道的初始化，这里返回一个捕获通道句柄。然后还需要定义一个回调函数，这个回调函数在检测到边缘事件时触发。定义一个结构体填充回调函数，调用接口把捕获通道句柄、回调函数以及任务句柄传进去，完成回调函数的初始化。接下来使能捕获通道，初始化缺口引脚为输出，最后使能捕获定时器。

回调函数有三个参数：第一个是捕获通道句柄，第二个是捕获到的数据，第三个是用户自定义参数。我们主要用第二个和第三个参数。首先判断捕获到的边缘是否是上升沿，如果是上升沿，记录当前计数值到静态变量；如果不是上升沿而是下降沿，记录当前计数值到另一个静态变量。如果捕获到下降沿，计算上升沿和下降沿定时器的差值，得到脉宽长度，并用任务通知函数把这个计数值发到 APP MAIN 函数中。

在 APP MAIN 函数的 WHILE 循环中，首先调用 TRIGGLE 函数触发开始信号，然后调用任务通知等待接口，等待脉冲宽度消息。收到通知后，获取定时器差值，并根据 APP 时钟频率将其转换为时间值。最后用公式将时间值转换为距离的厘米值。

根据超声波测距原理，距离 D 等于声速 V 乘以时间 T 再除以二。声速是 340 米/秒，时间单位转换为微秒，米转换为厘米后，公式化简为距离 D 等于 0.017 乘以 T，大约等于 T 除以 58。

将程序烧到开发板中测试，改变距离观察打印值，发现测距效果较为精确。这节课内容讲解完毕。
